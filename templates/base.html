{% load static %}
<!doctype html>
<html lang="uz">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Ustatop{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/site.css' %}">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold" href="{% url 'services:home' %}">Ustatop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="{% url 'services:category_list' %}">Kategoriya</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'listings:public_list' %}">E’lonlar</a></li>
          </ul>
          <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
              {% if user.is_provider %}
                <li class="nav-item"><a class="nav-link" href="{% url 'dashboard:provider_home' %}">Kabinet</a></li>
              {% endif %}
              {% if user.is_admin %}
                <li class="nav-item"><a class="nav-link" href="{% url 'dashboard:pending_listings' %}">Administrator</a></li>
              {% endif %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'accounts:logout' %}">Chiqish</a>
              </li>
            {% else %}
              <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Kirish</a></li>
              <li class="nav-item"><a class="btn btn-primary" href="{% url 'accounts:register' %}">Ro‘yxatdan o‘tish</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
      {% block content %}{% endblock %}
    </main>

    <footer class="border-top py-4 mt-5">
      <div class="container text-muted small">
        Ustatop — komissiyasiz ustalar bozori.
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function () {
        function formatThousands(value) {
          var cleaned = value.replace(/[^\d.,]/g, '').replace(/,/g, '.');
          if (!cleaned) return '';
          var parts = cleaned.split('.');
          var integer = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
          if (parts.length > 1) {
            return integer + '.' + parts[1].slice(0, 2);
          }
          return integer;
        }

        function bindThousands(input) {
          input.addEventListener('input', function () {
            input.value = formatThousands(input.value);
          });
        }

        function bindDeleteToggles(scope) {
          scope.querySelectorAll('.delete-toggle').forEach(function (toggle) {
            toggle.addEventListener('click', function (event) {
              event.preventDefault();
              var card = toggle.closest('.image-card');
              var checkbox = toggle.querySelector('input[type="checkbox"]');
              var fileInput = card ? card.querySelector('input[type="file"]') : null;
              if (checkbox) {
                checkbox.checked = true;
              }
              if (fileInput) {
                fileInput.value = '';
              }
              if (card) {
                card.classList.add('is-cleared');
              }
            });
          });
        }

        document.addEventListener('DOMContentLoaded', function () {
          document.querySelectorAll('input[data-thousands="true"]').forEach(bindThousands);
          bindDeleteToggles(document);
          document.querySelectorAll('input[data-autocomplete]').forEach(function (input) {
            var menu = input.parentElement.querySelector('.autocomplete-menu');
            var endpoint = input.getAttribute('data-autocomplete');
            if (!menu || !endpoint) return;
            var timer;

            function render(items) {
              if (!items.length) {
                menu.classList.add('d-none');
                menu.innerHTML = '';
                return;
              }
              menu.innerHTML = items
                .map(function (item) {
                  return (
                    '<button type="button" class="autocomplete-item" data-value="' +
                    item.name +
                    '" data-id="' +
                    item.id +
                    '">' +
                    item.name +
                    ' <span>' +
                    item.category +
                    '</span></button>'
                  );
                })
                .join('');
              menu.classList.remove('d-none');
            }

            input.addEventListener('input', function () {
              clearTimeout(timer);
              var value = input.value.trim();
              var hidden = input.closest('form').querySelector('[data-service-id]');
              if (hidden) {
                hidden.value = '';
              }
              if (value.length < 2) {
                render([]);
                return;
              }
              timer = setTimeout(function () {
                fetch(endpoint + '?q=' + encodeURIComponent(value))
                  .then(function (res) {
                    return res.json();
                  })
                  .then(function (data) {
                    render(data.results || []);
                  })
                  .catch(function () {
                    render([]);
                  });
              }, 150);
            });

            menu.addEventListener('click', function (event) {
              var target = event.target.closest('.autocomplete-item');
              if (!target) return;
              input.value = target.getAttribute('data-value');
              var hidden = input.closest('form').querySelector('[data-service-id]');
              if (hidden) {
                hidden.value = target.getAttribute('data-id') || '';
              }
              render([]);
              input.focus();
              updateServiceRequired(input.closest('form'));
            });

            document.addEventListener('click', function (event) {
              if (!input.contains(event.target) && !menu.contains(event.target)) {
                render([]);
              }
            });
          });

          function updateServiceRequired(form) {
            if (!form || !form.hasAttribute('data-require-service')) return;
            var hidden = form.querySelector('[data-service-id]');
            var submit = form.querySelector('button[type="submit"]');
            if (!submit) return;
            submit.disabled = !hidden || !hidden.value;
          }

          document.querySelectorAll('form[data-require-service="true"]').forEach(function (form) {
            updateServiceRequired(form);
            var input = form.querySelector('input[data-autocomplete]');
            if (input) {
              input.addEventListener('input', function () {
                updateServiceRequired(form);
              });
            }
          });

          document.querySelectorAll('form[data-ask-questions="true"]').forEach(function (form) {
            form.addEventListener('submit', function (event) {
              var hidden = form.querySelector('[data-service-id]');
              if (!hidden || !hidden.value) {
                return;
              }
              event.preventDefault();
              var modal = document.getElementById('homeFilterModal');
              if (!modal) {
                form.submit();
                return;
              }
              var modalInstance = bootstrap.Modal.getOrCreateInstance(modal);
              var formInModal = modal.querySelector('#home-filter-form');
              if (formInModal) {
                formInModal.querySelector('input[name="q"]').value = form.querySelector('input[name="q"]').value;
                formInModal.querySelector('input[name="service_id"]').value = hidden.value;
                var stepper = modal.querySelector('#home-steps');
                if (stepper) {
                  stepper.setAttribute('data-service', hidden.value);
                }
              }
              modalInstance.show();
            });
          });

          document.querySelectorAll('[data-skip-search]').forEach(function (button) {
            button.addEventListener('click', function () {
              var modal = button.closest('.modal');
              var form = modal ? modal.querySelector('#home-filter-form') : null;
              if (form) {
                form.submit();
              }
            });
          });
          function renderStepper(container, groups, selected, fieldName) {
            if (!groups.length) {
              container.innerHTML = '<div class="text-muted small">Xizmat tanlang — savollar chiqadi.</div>';
              return;
            }
            var steps = groups
              .map(function (group, index) {
                return (
                  '<button type="button" class="step-indicator' +
                  (index === 0 ? ' active' : '') +
                  '" data-step="' +
                  index +
                  '">' +
                  (index + 1) +
                  '</button>'
                );
              })
              .join('');
            var panels = groups
              .map(function (group, index) {
                var options = group.options
                  .map(function (option) {
                    var checked = selected.indexOf(String(option.id)) !== -1 ? 'checked' : '';
                    return (
                      '<label class="detail-item">' +
                      '<input type="checkbox" name="' +
                      fieldName +
                      '" value="' +
                      option.id +
                      '" ' +
                      checked +
                      '> ' +
                      '<span>' +
                      option.name +
                      '</span></label>'
                    );
                  })
                  .join('');
                return (
                  '<div class="step-panel' +
                  (index === 0 ? ' active' : '') +
                  '" data-step="' +
                  index +
                  '">' +
                  '<div class="step-title">' +
                  group.question +
                  '</div>' +
                  '<div class="detail-grid">' +
                  options +
                  '</div>' +
                  '<div class="step-hint text-muted small">Kamida bitta javob tanlang.</div>' +
                  '</div>'
                );
              })
              .join('');
            container.innerHTML =
              '<div class="stepper-header">' +
              steps +
              '</div>' +
              panels +
              '<div class="stepper-actions">' +
              '<button type="button" class="btn btn-outline-secondary btn-sm" data-step-action="prev">Orqaga</button>' +
              '<button type="button" class="btn btn-primary btn-sm" data-step-action="next">Keyingi</button>' +
              '</div>';
          }

          function bindStepper(container) {
            var indicators = container.querySelectorAll('.step-indicator');
            var panels = container.querySelectorAll('.step-panel');
            var current = 0;

            function setStep(index) {
              current = index;
              indicators.forEach(function (indicator) {
                indicator.classList.toggle('active', Number(indicator.dataset.step) === current);
              });
              panels.forEach(function (panel) {
                panel.classList.toggle('active', Number(panel.dataset.step) === current);
              });
              var prev = container.querySelector('[data-step-action="prev"]');
              var next = container.querySelector('[data-step-action="next"]');
              var panel = panels[current];
              var hasAnswer = panel && panel.querySelector('input[type="checkbox"]:checked');
              if (prev) {
                prev.disabled = current === 0;
              }
              if (next) {
                next.disabled = current === panels.length - 1 || !hasAnswer;
              }
              container.dataset.step = String(current);
              container.dispatchEvent(new CustomEvent('stepChanged', { detail: { step: current } }));
            }

            container.querySelectorAll('[data-step-action]').forEach(function (button) {
              button.addEventListener('click', function () {
                if (button.dataset.stepAction === 'prev' && current > 0) {
                  setStep(current - 1);
                }
                if (button.dataset.stepAction === 'next' && current < panels.length - 1) {
                  setStep(current + 1);
                }
              });
            });

            indicators.forEach(function (indicator) {
              indicator.addEventListener('click', function () {
                setStep(Number(indicator.dataset.step));
              });
            });

            container.addEventListener('change', function () {
              setStep(current);
            });

            setStep(0);
          }

          document.querySelectorAll('#service-details, #filter-steps, #home-steps').forEach(function (container) {
            var endpoint = container.getAttribute('data-endpoint');
            var selected = (container.getAttribute('data-selected') || '').split(',').filter(Boolean);
            var mode = container.getAttribute('data-mode') || 'provider';
            var fieldName = mode === 'filter' ? 'detail' : 'service_details';
            var serviceSelect = document.querySelector('select[name="service"]');
            var categorySelect = document.querySelector('select[name="category"]');
            var formWithEndpoint = serviceSelect ? serviceSelect.closest('form[data-services-endpoint]') : null;
            var servicesEndpoint = formWithEndpoint ? formWithEndpoint.getAttribute('data-services-endpoint') : null;
            var staticService = container.getAttribute('data-service');

            function loadDetails(serviceId) {
              if (!serviceId || !endpoint) {
                container.innerHTML = '<div class="text-muted small">Xizmat tanlang — savollar chiqadi.</div>';
                return;
              }
              fetch(endpoint + '?service_id=' + encodeURIComponent(serviceId))
                .then(function (res) {
                  return res.json();
                })
                .then(function (data) {
                  renderStepper(container, data.results || [], selected, fieldName);
                  bindStepper(container);
                })
                .catch(function () {
                  container.innerHTML = '<div class="text-muted small">Savollarni yuklab bo‘lmadi.</div>';
                });
            }

            container.__loadDetails = loadDetails;

            if (staticService) {
              loadDetails(staticService);
            } else if (serviceSelect && serviceSelect.value) {
              loadDetails(serviceSelect.value);
            }

            if (serviceSelect) {
              serviceSelect.addEventListener('change', function () {
                selected = [];
                loadDetails(serviceSelect.value);
              });
            }

            if (categorySelect && servicesEndpoint) {
              categorySelect.addEventListener('change', function () {
                var categoryId = categorySelect.value;
                if (serviceSelect) {
                  serviceSelect.innerHTML = '<option value="">---------</option>';
                }
                container.innerHTML = '<div class="text-muted small">Xizmat tanlang — savollar chiqadi.</div>';
                if (!categoryId) return;
                fetch(servicesEndpoint + '?category_id=' + encodeURIComponent(categoryId))
                  .then(function (res) {
                    return res.json();
                  })
                  .then(function (data) {
                    (data.results || []).forEach(function (service) {
                      var option = document.createElement('option');
                      option.value = service.id;
                      option.textContent = service.name;
                      if (serviceSelect) {
                        serviceSelect.appendChild(option);
                      }
                    });
                  });
              });
            }
          });

          document.querySelectorAll('#homeFilterModal').forEach(function (modal) {
            modal.addEventListener('show.bs.modal', function () {
              var stepper = modal.querySelector('#home-steps');
              if (!stepper || !stepper.__loadDetails) return;
              var serviceId = stepper.getAttribute('data-service');
              if (serviceId) {
                stepper.__loadDetails(serviceId);
              }
            });
          });

          document.querySelectorAll('#homeFilterModal, #filterModal').forEach(function (modal) {
            var actionButton = modal.querySelector('.js-search-submit');
            var stepper = modal.querySelector('.stepper');
            if (!actionButton || !stepper) return;
            actionButton.disabled = true;
            stepper.addEventListener('stepChanged', function () {
              var panels = stepper.querySelectorAll('.step-panel');
              if (!panels.length) return;
              var current = Number(stepper.dataset.step || '0');
              var isLast = current === panels.length - 1;
              if (!isLast) {
                actionButton.disabled = true;
                return;
              }
              var hasAnswer = panels[current].querySelector('input[type="checkbox"]:checked');
              actionButton.disabled = !hasAnswer;
            });
          });
          document.querySelectorAll('[data-copy]').forEach(function (button) {
            button.addEventListener('click', function () {
              var text = button.getAttribute('data-copy');
              if (!text) return;
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function () {
                  button.textContent = 'Nusxalandi';
                  setTimeout(function () {
                    button.textContent = text + ' ni nusxalash';
                  }, 1500);
                });
              } else {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                button.textContent = 'Nusxalandi';
                setTimeout(function () {
                  button.textContent = text + ' ni nusxalash';
                }, 1500);
              }
            });
          });
          document.querySelectorAll('form').forEach(function (form) {
            form.addEventListener('submit', function () {
              form.querySelectorAll('input[data-thousands="true"]').forEach(function (input) {
                input.value = input.value.replace(/\s/g, '').replace(/,/g, '.');
              });
            });
          });

        });
      })();
    </script>
  </body>
</html>
